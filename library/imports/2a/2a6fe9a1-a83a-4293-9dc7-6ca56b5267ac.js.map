{"version":3,"sources":["assets\\scripts\\Framework\\GameMgr.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import GameCtr from \"./GameCtr\";\r\nimport { cocosz } from \"./CocosZ\";\r\nimport Constant, { PageName, GameState, PanelName } from \"./Constant\";\r\nimport Msg from \"./Msg\";\r\nimport { utils } from \"../../common-plugin/Scripts/Utils\";\r\nimport YZ_Constant, { LevelStatus, YZ_Reward } from \"../../common-plugin/Scripts/YZ_Constant\";\r\nimport YZ_LocalStorage from \"../../common-plugin/Scripts/YZ_LocalStorage\";\r\nimport {upgradeMgr} from \"../Game/UpgradeMgr\"\r\n// @ts-ignore\r\nconst i18n = require('LanguageData');\r\n\r\n/**\r\n * 游戏管理\r\n */\r\nexport default class GameMgr {\r\n\r\n    private static _inst: GameMgr;\r\n    public static get inst(): GameMgr {\r\n        if (!GameMgr._inst) {\r\n            GameMgr._inst = new GameMgr();\r\n        }\r\n        return GameMgr._inst;\r\n    }\r\n\r\n    protected _state: GameState = GameState.None;\r\n    public get State() {\r\n        return this._state;\r\n    }\r\n    public set State(value: GameState) {\r\n        this._state = value;\r\n    }\r\n\r\n    private _gameCtr: GameCtr = new GameCtr();;\r\n    public get gameCtr() {\r\n        return this._gameCtr;\r\n    }\r\n\r\n\r\n    public gameStartTime: number = 0;\r\n    private canTry: boolean = true;\r\n    private canGame: boolean = true;\r\n    /**\r\n     * 开始游戏\r\n     * @param 关卡ID\r\n     */\r\n    public async gameStart(levelId: number) {\r\n        YZ_LocalStorage.setItem(YZ_Constant.ST_RED_BAG_PROGRESS, '0');\r\n        cocosz.curLevel = levelId;\r\n        // 重置\r\n        if (this.canTry) {\r\n            this.canTry = false;\r\n            this.gameCtr.curUseSkinId = -1;\r\n            // 能否弹试用\r\n            if (cocosz.isShowAd && cocosz.isADON && (cocosz.isDeBug || utils.isShowTrySkin(levelId))) {\r\n                let rangeLevel = cocosz.dataMgr.getGunInfo(cocosz.dataMgr.CurRange).Level;\r\n                if (Math.random() < 0.5 && (rangeLevel < 3)) {\r\n                    // 武器升级弹窗\r\n                    cocosz.uiMgr.openPanel(PanelName.UIWeaponLevelPanel);\r\n                } else {\r\n                    // 皮肤试用弹窗\r\n                    // cocosz.uiMgr.openPanel(PanelName.UITrySkinPanel);\r\n                }\r\n            }\r\n            // 进入游戏\r\n            else if (this.canGame) {\r\n                this.canGame = false;\r\n                this._loadGameScene();\r\n            }\r\n        }\r\n        // 能否进入游戏\r\n        else if (this.canGame) {\r\n            this.canGame = false;\r\n            this._loadGameScene();\r\n        }\r\n    }\r\n\r\n    private _loadGameScene() {\r\n        // 使用皮肤\r\n        if (this.gameCtr.curUseSkinId < 0) {\r\n            this.gameCtr.curUseSkinId = cocosz.dataMgr.CurSkinId;\r\n        }\r\n        //上报游戏开始\r\n        utils.StartGame(cocosz.getLevelId().toString());\r\n        //进入游戏场景\r\n        cocosz.sceneMgr.loadScene(\"Game\", () => {\r\n            this.gameStartTime = new Date().getTime();\r\n            this.canTry = true;\r\n            this.canGame = true;\r\n            this._gamePrepare();\r\n            //显示过度页面\r\n            cocosz.uiMgr.openPage(PageName.UIGameLoadingPage);\r\n        });\r\n    }\r\n\r\n    /** 游戏预加载 */\r\n    private _gamePrepare() {\r\n        try {\r\n            this.State = GameState.Prepare;\r\n            //调用游戏初始化\r\n            this.gameCtr.init();\r\n        } catch (error) {\r\n            cc.error(\"erro >>\", error);\r\n            // 资源没有准备好, 无法进入游戏\r\n            cocosz.sceneMgr.loadScene(\"Home\", () => {\r\n                cocosz.uiMgr.openPage(PageName.UIHomePage);\r\n                Msg.Show(i18n.t(\"msg.net_error\"));//当前网络状态不佳，请重启游戏\r\n            });\r\n        }\r\n    }\r\n\r\n    /** 游戏胜利 */\r\n    public gameSuccess() {\r\n        cc.log('游戏胜利!');\r\n        this.State = GameState.Success;\r\n        cocosz.audioMgr.playEffectWinner();\r\n        // 上报游戏时间\r\n        let gameTime = Math.round((new Date().getTime() - this.gameStartTime) / 1000 / 60);\r\n        utils.SendEvent(\"游戏时间:\" + gameTime + \"分钟\");\r\n        //保存关卡解锁数据\r\n        let rewardCallFunc = (res: YZ_Reward) => {\r\n            cc.log(\"获取激励组件奖励+\" + res.rewardValue)\r\n            if (res) {\r\n                cocosz.dataMgr.CoinCount += res.rewardValue;\r\n                cc.game.emit(Constant.E_GAME_LOGIC, { type: Constant.E_COIN_CHANGE });\r\n            }\r\n        };\r\n\r\n        let closeCallFunc = () => {\r\n            cc.log(\"激励组件关闭！！！！！！\");\r\n            cocosz.uiMgr.openPage(PageName.UIOverPage);\r\n        }\r\n\r\n        //显示结算前广告\r\n        utils.adManager.showBeforGameOverAd(cocosz.getLevelId(), LevelStatus.GameWin, 100, closeCallFunc, rewardCallFunc);\r\n\r\n    }\r\n\r\n    /** 游戏失败 */\r\n    public gameFailed() {\r\n        cc.log('游戏失败!');\r\n        this.State = GameState.Failed;\r\n        cocosz.audioMgr.playEffectFailed();\r\n        // 上报游戏时间\r\n        let gameTime = Math.round((new Date().getTime() - this.gameStartTime) / 1000 / 60);\r\n        utils.SendEvent(\"游戏时间:\" + gameTime + \"分钟\");\r\n\r\n        console.log(\"当前游戏等级为\"+upgradeMgr.curLevel.toString());\r\n        let url: string = Constant.WEB_LINE_TITLE + '/qwk/charts/updateTheCharts/'  + Constant.PERSON_TPKKEN + \"/\" + Constant.GAME_ID + \"/\";   //用户id与游戏id目前为1和1\r\n        url += (gameTime * 60 * upgradeMgr.curLevel).toString();\r\n        utils.showLog(\"上报数据, url=\", url);\r\n        utils.commomHttpRequest(url, (ret, jsdata) => {\r\n            if (ret) {\r\n                utils.showLog(\"数据上报成功！\");\r\n            } else {\r\n                utils.showLog(\"数据上报失败！\");\r\n            }\r\n        });\r\n\r\n        let rewardCallFunc = (res: YZ_Reward) => {\r\n            cc.log(\"获取激励组件奖励+\" + res.rewardValue)\r\n            if (res) {\r\n                //保存奖励值到本地\r\n                cocosz.dataMgr.CoinCount += res.rewardValue;\r\n                cc.game.emit(Constant.E_GAME_LOGIC, { type: Constant.E_COIN_CHANGE });\r\n            }\r\n        };\r\n\r\n        let closeCallFunc = () => {\r\n            cc.log(\"激励组件关闭！！！！！！\");\r\n            cocosz.uiMgr.openPage(PageName.UIOverPage);\r\n        }\r\n\r\n        utils.adManager.showBeforGameOverAd(cocosz.getLevelId(), LevelStatus.GameFail, 50, closeCallFunc, rewardCallFunc);\r\n    }\r\n}\r\n"]}