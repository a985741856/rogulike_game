{"version":3,"sources":["assets\\scripts\\Framework\\GameCtr.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import Constant, { GameState, PageName, PanelName } from \"./Constant\";\r\nimport { cocosz } from \"./CocosZ\";\r\nimport { gameMgr } from \"../Game/gameMgr\";\r\n\r\n\r\n/**\r\n * 游戏控制类\r\n * 实现游戏的基础逻辑\r\n */\r\n\r\nexport default class GameCtr {\r\n    public curUseSkinId: number = -1;// 使用皮肤id\r\n\r\n    public loadProgress: number = 0;// 总加载进度\r\n    private _loadMapPro: number = 0;// 地图加载进度\r\n    private _totalCount: number = 0;// 资源总数\r\n    private _compCount: number = 0;// 资源完成数量\r\n\r\n    private _pathBack: string = \"\";\r\n    private _prefabBack: cc.Prefab = null;\r\n\r\n    //游戏初始化\r\n    public init() {\r\n        this.loadProgress = 0;\r\n        this._loadMapPro = 0;\r\n        this._totalCount = 0;\r\n        this._compCount = 0;\r\n        this.loadRes();\r\n    }\r\n\r\n    updateLoadRes() {\r\n        this.loadProgress = (this._loadMapPro + this._compCount / this._totalCount) / 2;\r\n        // 开启地图加载\r\n        if (this._compCount >= this._totalCount && this._loadMapPro == 0) {\r\n            this._loadMapPro = 0.01;\r\n            this.loadMap();\r\n        }\r\n        cc.game.emit(Constant.E_GAME_LOGIC, { type: Constant.E_UPDATE_PROGRESS, data: this.loadProgress })\r\n    }\r\n\r\n    loadRes() {\r\n        // 游戏音效\r\n        let mess1: any = [];\r\n        // 地下城音效\r\n        let mess2: any = [];\r\n        // 地下城技能预制体\r\n        let mess3: any = [];\r\n\r\n        // 游戏音效\r\n        cocosz.getDirWithPath(\"audio_game\", cc.AudioClip, mess1);\r\n        cocosz.resMgr.loadAndCacheResArray(mess1, cc.AudioClip, null, () => {\r\n            this._compCount++;\r\n            this.updateLoadRes();\r\n        });\r\n        // 地下城\r\n        if (6 == cocosz.gameMode || 8 == cocosz.gameMode) {\r\n            // 音效\r\n            cocosz.getDirWithPath(\"audio_zombie\", cc.AudioClip, mess2);\r\n            cocosz.resMgr.loadAndCacheResArray(mess2, cc.AudioClip, null, () => {\r\n                this._compCount++;\r\n                this.updateLoadRes();\r\n            });\r\n            // 预制体\r\n            cocosz.getDirWithPath(\"prefab_zombie_skill\", cc.Prefab, mess3);\r\n            cocosz.resMgr.loadAndCacheResArray(mess3, cc.Prefab, null, () => {\r\n                this._compCount++;\r\n                this.updateLoadRes();\r\n            })\r\n        }\r\n        // 资源总数\r\n        this._totalCount = mess1.length + mess2.length + mess3.length;\r\n    }\r\n\r\n    loadMap() {\r\n        let path = \"maps/mapzombie\";\r\n        // 释放地图资源\r\n        if (this._pathBack != path && this._prefabBack && this._prefabBack.isValid) {\r\n            cc.assetManager.releaseAsset(this._prefabBack)\r\n        }\r\n        // 加载地图\r\n        cocosz.resMgr.loadRes(path, cc.Prefab, ((cur, total) => {\r\n            if (cur / total > this._loadMapPro) {\r\n                this._loadMapPro = cur / total;\r\n            }\r\n            if (this._loadMapPro > 0.99) this._loadMapPro = 0.99;\r\n            this.updateLoadRes();\r\n        }), ((err, res: any) => {\r\n            if (err) {\r\n                console.log(err);\r\n                cocosz.sceneMgr.loadScene(\"Home\", (() => {\r\n                    cocosz.uiMgr.openPage(PageName.UIHomePage);\r\n                }));\r\n            }\r\n            else {\r\n                this._pathBack = path;\r\n                this._prefabBack = res;\r\n                gameMgr.map = cc.instantiate(res);\r\n                gameMgr.initPos();\r\n                gameMgr.mapSize = gameMgr.map.getContentSize();\r\n                gameMgr.node.addChild(gameMgr.map, -5);\r\n                this._loadMapPro = 1;\r\n                this.updateLoadRes();\r\n            }\r\n        }))\r\n    }\r\n}\r\n"]}